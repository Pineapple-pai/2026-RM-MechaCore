# RoboMaster 飞镖系统技术文档

## 项目结构概述

本项目为 RoboMaster 机器人飞镖发射系统，采用模块化设计，主要分为以下几个部分：

- **APP_Task**：任务调度与主循环（如 Dart.cpp），负责系统初始化、周期性事件处理和主控制流程。
- **硬件驱动**：包括电机驱动、传感器采集、GPIO 控制等底层硬件接口，确保各部件稳定运行。
- **通信模块**：实现与遥控器、裁判系统、视觉模块等的 CAN/UART 通信，支持 DMA/中断高效数据传输。
- **控制算法**：核心为 PID 控制器，负责摩擦轮、丝杆、云台等电机的速度和位置闭环控制。
- **状态管理**：涵盖系统状态机、限位开关检测、模式切换与安全保护机制。

## 主要模块说明

### 1. Dart.cpp（主任务与控制逻辑）

- `Dart1` 任务函数：系统主循环，周期性处理飞镖相关控制逻辑。每 1ms 检查系统状态、遥控器输入、裁判系统反馈等。
- `Dart_c` 类：封装飞镖系统的初始化、事件处理、控制模式切换等功能。包括参数初始化、定期事件、遥控器连接检测、速度控制、手动控制、自动发射、紧急停止等方法。
- 状态变量：如 `Yaw_Angle`（云台角度）、`Rpm_Change_Lock`（转速锁定）、`AutoLaunch`（自动发射状态与计数）等。
- 控制流程：
  - 初始化各硬件和通信接口（CAN/UART/DMA）
  - 定期事件检查（裁判系统状态、限位开关、遥控器连接）
  - 根据遥控器状态切换控制模式（速度控制、手动控制、自动发射）
  - 紧急停止与安全保护，确保异常情况下系统安全

### 2. 通信与数据交互

- **CAN 通信**：用于电机控制与状态反馈，支持多路电机同步控制。
- **UART 通信**：遥控器、裁判系统、视觉模块等数据接收，采用 DMA/中断方式提升效率。
- **DMA/IT**：高效数据传输与中断处理，减少 CPU 占用，提升实时性。
- **数据结构**：如 `DT7UartCom`（遥控器数据）、`VisionUartReceive`（视觉数据）、`MyRefereeSys8Data`（裁判系统数据）等。

### 3. 控制算法

- **PID 控制器**：针对各电机（摩擦轮、丝杆、云台等）进行速度/位置闭环控制，参数可调节以适应不同机械结构。
- **目标值限制**：通过 `Limit_Value` 函数确保目标值在安全范围内，防止越界损坏硬件。
- **同步机制**：如 Yaw 轴角度同步，保证多电机协同工作。
- **模式切换**：根据遥控器拨杆和摇杆状态，自动切换速度控制、手动控制和自动发射模式。

### 4. 状态与模式管理

- **RefereeSystemState**：裁判系统状态机，判断仓门状态和比赛倒计时，影响发射权限。
- **Rpm_Change_Lock**：转速锁定机制，防止误操作导致电机异常。
- **AutoLaunch**：自动发射流程与计数，支持 15s 自动发射和裁判系统模式。
- **限位开关检测**：通过 GPIO 采集左右限位，保护机械安全。

## 数据流与典型场景

1. **系统启动**：初始化各硬件接口，配置 CAN/UART/DMA，进入主循环。
2. **遥控器连接检测**：周期性检查遥控器摇杆和拨杆状态，判断是否连接，未连接时执行紧急停止。
3. **控制模式切换**：根据遥控器拨杆状态，自动切换速度控制、手动控制、自动发射三种模式。
4. **电机目标值调整**：根据遥控器输入和系统状态，动态调整摩擦轮、丝杆、云台等电机目标值，确保响应及时且安全。
5. **自动发射流程**：支持 15s 自动发射和裁判系统模式，自动计数和状态管理。
6. **紧急停止**：在遥控器断开或异常情况下，立即停止所有电机，重置发射参数，保障安全。

## 扩展与定制

- 支持多种遥控器和裁判系统协议，便于适配不同比赛规则。
- 可扩展视觉识别与自动瞄准功能，提升智能化水平。
- 电机参数与 PID 可通过配置文件或通信接口远程调整，便于调试和优化。
- 支持多线程任务调度，提升系统响应速度和稳定性。

## 代码风格与规范

- 采用 C++ 面向对象设计，模块职责清晰，便于维护和扩展。
- 关键流程均有详细注释，方便新成员快速理解和上手。
- 变量命名清晰，遵循统一风格，提升代码可读性。
- 充分利用标准库和 HAL 库，提升代码可靠性和移植性。
